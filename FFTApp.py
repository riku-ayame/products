import streamlit as st
import numpy as np
import pandas as pd
from scipy.fft import fft, fftfreq, ifft

# 1. ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜
st.title("âš¡ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ FFTãƒã‚¤ã‚ºã‚­ãƒ£ãƒ³ã‚»ãƒ©ãƒ¼")
st.write("é›»æ°—é›»å­å·¥å­¦ã®å¼·åŠ›ãªæ­¦å™¨ã€Œé«˜é€Ÿãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›ï¼ˆFFTï¼‰ã€ã‚’ä½¿ã£ã¦ã€ãƒã‚¤ã‚ºã¾ã¿ã‚Œã®æ³¢å½¢ã‹ã‚‰ç¶ºéº—ãªä¿¡å·ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã—ã¦ã¿ã¦ãã ã•ã„ï¼")

# 2. ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆç”»é¢å·¦å´ã®è¨­å®šãƒ‘ãƒãƒ«ï¼‰ã‚’ä½œæˆ
st.sidebar.header("âš™ï¸ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š")
base_freq = st.sidebar.slider("æœ¬æ¥ã®ä¿¡å·ã®å‘¨æ³¢æ•° (Hz)", 1, 10, 3)
noise_level = st.sidebar.slider("ãƒã‚¤ã‚ºã®å¼·ã•", 0.0, 2.0, 1.0)
cutoff_freq = st.sidebar.slider("âœ‚ï¸ ã‚«ãƒƒãƒˆã‚ªãƒ•å‘¨æ³¢æ•° (Hz)", 1, 50, 10)
st.sidebar.write("â€»ã‚«ãƒƒãƒˆã‚ªãƒ•å‘¨æ³¢æ•°ã‚ˆã‚Šé«˜ã„å‘¨æ³¢æ•°æˆåˆ†ï¼ˆãƒã‚¤ã‚ºï¼‰ã‚’ã‚¼ãƒ­ã«ã—ã¦é€†FFTã—ã¾ã™ã€‚")

# 3. ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆï¼ˆæœ¬æ¥ã®æ³¢ ï¼‹ ãƒ©ãƒ³ãƒ€ãƒ ãƒã‚¤ã‚ºï¼‰
N = 500 # ãƒ‡ãƒ¼ã‚¿æ•°
T = 1.0 / 100.0 # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°é–“éš”
t = np.linspace(0.0, N*T, N, endpoint=False)

# æœ¬æ¥ã®ç¶ºéº—ãªã‚µã‚¤ãƒ³æ³¢
clean_signal = np.sin(2.0 * np.pi * base_freq * t)
# ãƒã‚¤ã‚ºã‚’è¿½åŠ ã—ãŸå—ä¿¡æ³¢å½¢
noisy_signal = clean_signal + noise_level * np.random.randn(N)

# 4. FFTï¼ˆé«˜é€Ÿãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›ï¼‰ã®å®Ÿè¡Œ
yf = fft(noisy_signal)
xf = fftfreq(N, T)[:N//2] # ãƒ—ãƒ©ã‚¹ã®å‘¨æ³¢æ•°ã ã‘å–ã‚Šå‡ºã™
amplitude = 2.0/N * np.abs(yf[0:N//2]) # æŒ¯å¹…ã‚’è¨ˆç®—

# 5. ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†ï¼ˆé«˜å‘¨æ³¢ãƒã‚¤ã‚ºã®ã‚«ãƒƒãƒˆï¼‰
yf_filtered = yf.copy()
# ã‚«ãƒƒãƒˆã‚ªãƒ•å‘¨æ³¢æ•°ã‚ˆã‚Šé«˜ã„æˆåˆ†ã‚’å¼·åˆ¶çš„ã«0ã«ã™ã‚‹
yf_filtered[np.abs(fftfreq(N, T)) > cutoff_freq] = 0

# é€†FFTã§æ™‚é–“é ˜åŸŸï¼ˆå…ƒã®æ³¢å½¢ï¼‰ã«æˆ»ã™
filtered_signal = np.real(ifft(yf_filtered))

# ==========================================
# ğŸ“Š ç”»é¢ã¸ã®ã‚°ãƒ©ãƒ•æç”»
# ==========================================

st.subheader("1. ãƒã‚¤ã‚ºã¾ã¿ã‚Œã®å—ä¿¡ä¿¡å·ï¼ˆTime Domainï¼‰")
st.line_chart(pd.DataFrame({"Noisy Signal": noisy_signal}, index=t))

st.subheader("2. FFTè§£æçµæœï¼ˆFrequency Domainï¼‰")
st.write("æ¨ªè»¸ãŒå‘¨æ³¢æ•°ã€ç¸¦è»¸ãŒå¼·ã•ã§ã™ã€‚æœ¬æ¥ã®ä¿¡å·ã®å‘¨æ³¢æ•°ã«å¤§ããªãƒ”ãƒ¼ã‚¯ãŒã‚ã‚Šã€ãã‚Œä»¥å¤–ãŒãƒã‚¤ã‚ºã§ã™ã€‚")
st.line_chart(pd.DataFrame({"Amplitude": amplitude}, index=xf))

st.subheader("3. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ä¿¡å·ï¼ˆé€†FFTï¼‰")
st.write("é«˜å‘¨æ³¢ãƒã‚¤ã‚ºã‚’ã‚«ãƒƒãƒˆã—ã¦å¾©å…ƒã—ãŸæ³¢å½¢ã§ã™ã€‚å…ƒã®ç¶ºéº—ãªã‚µã‚¤ãƒ³æ³¢ã«è¿‘ã¥ã„ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼")
# æ¯”è¼ƒã—ã‚„ã™ã„ã‚ˆã†ã«ã€æœ¬æ¥ã®æ³¢ã¨ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®æ³¢ã‚’é‡ã­ã¦è¡¨ç¤º
df_result = pd.DataFrame({
    "Filtered (ãƒã‚¤ã‚ºé™¤å»å¾Œ)": filtered_signal,
    "Original (æœ¬æ¥ã®ç¶ºéº—ãªæ³¢)": clean_signal
}, index=t)
st.line_chart(df_result)